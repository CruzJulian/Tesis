---
title: "Simulaci칩n"
author: "Julian Cruz"
output: 
  pdf_document:
    keep_tex: true
    toc: false
    number_sections: true
bibliography: Biblio.bib
csl: apa.csl
linkcolor: blue

---

## Lista de cosas

 - probar varias distancias
 - hacer gr치ficos cuadrados de distancias de la misma distribuci칩n
 - Hacer simulaciones propuestas hace 3 a침os.

```{r setup, include=FALSE}
library("agricolae")
library("magrittr")
library("Rcpp")
library("FactoMineR")
library("dplyr")

knitr::opts_chunk$set(echo = TRUE)

sourceCpp("distancia.cpp")
```

```{r}
to_nubepuntos <- function(a){
  data.frame(value = a, weight = 1/length(a)) -> nubepuntos
 class(nubepuntos) <- c("data.frame", "nubepuntos")
  nubepuntos
}

dist_nubes <- function(nube_0, nube_1){
  rbind(
    cbind(nube_0, binary = 0),
    cbind(nube_1, binary = 1)
  ) -> tmp
  
  nrow(tmp) * distan_np(tmp[order(tmp$value),])
}

# rnorm(1000) -> a
# rnorm(840) -> b
# 
# a <- to_nubepuntos(a)
# b <- to_nubepuntos(b)
# 
# dist_nubes(b, a)

```

```{r}
collapsa_nubes <- function(nube_list){
  
  sum(unlist(lapply(nube_list, nrow))) -> n_total
  lapply(nube_list, function(nube){
    nube$weight <- nube$weight*nrow(nube)/n_total
    nube}) -> .
  do.call(rbind, .) -> nubepuntos
    class(nubepuntos) <- c("data.frame", "nubepuntos")
  nubepuntos

}

list_outer <- function(a,b, fun) {
  outer(a, b, function(x,y) vapply(seq_along(x), function(i) fun(x[[i]], y[[i]]), numeric(1)))
}


```

```{r}
k_clouds <- function(lista_nubes, n_grupos){
  
  sample(length(lista_nubes), n_grupos, replace = FALSE) -> cuales
  
  centros <- setNames(lista_nubes[cuales], LETTERS[1:n_grupos])
  antes <- 0
  ahora <- 1000
  umbral <- 0.01
  while(abs(antes - ahora) > umbral){
    antes <- ahora
    list_outer(centros, lista_nubes, dist_nubes) -> dist_matriz
    letters[apply(dist_matriz, 2, which.min)] -> grupos
    sum(apply(dist_matriz, 2, min)) -> ahora
    split(lista_nubes, grupos) -> agrupados
    lapply(agrupados, collapsa_nubes) -> centros
    
  }
  
  data.frame(trt = names(lista_nubes), Grupo = grupos)
  
}

# ep_means(lista_nubes, 5)
# 
# lapply(1:100, function(i){rnorm(i)}) %>% lapply(to_nubepuntos) -> datos
# 
# lapply(1:10, function(i){rnorm(rpois(1, 100), 50)}) %>% lapply(to_nubepuntos) -> centros
# 
# list_outer(datos, datos, dist_nubes) -> ppp

```



```{r}
# setwd("/media/TI106180W0A/Users/julian cruz/Desktop/Investigaciones/CLASIFICA/R")
# source("CLASS.R")

sigma<-1.5

Simul_tabla <- function(sigma){

  data.frame(
    Y = c(
      rnorm(40,1,sigma),
      rnorm(40,2,3*sigma),
      rnorm(40, 3,sigma), 
      rnorm(40, 4, 5*sigma), 
      rnorm(40, 5, sigma)
    ),
    X = rep(
      LETTERS[1:20], 
      each=10)
  ) -> datos
  
  # Media
  Media_trt <- datos %$% aggregate(Y, list(X), mean) %>% setNames(c("trt", "Media"))
  
  #Duncan
  DUNCAN <- aov(Y~X, data = datos) %>% duncan.test("X")
  
  #LSD
  LSD <- aov(Y~X, data = datos) %>% LSD.test("X")
  
  #K clouds
  datos %$% split(Y, X) %>% lapply(to_nubepuntos) %>% k_clouds(5) -> CC
  
list(
  Media_trt,
  data.frame(
      trt = LETTERS[1:20],
      Grupo = rep(letters[1:5], each = 4)
      ),
  CC, 
  LSD$groups[-2], 
  DUNCAN$groups[-2]
  ) -> tmp

Reduce(function(dtf1,dtf2) left_join(dtf1,dtf2, by = "trt"), tmp) %>% 
  setNames(c("Tratamiento", "Media", "Grupo Inicial", "K clouds", "LSD", "Duncan"))
  
}


#revisar kruskal wallis
CC$kruskal.inicial#debe ser cercano a cero
CC$kruskal.grupos.pval#deben ser altos
CC$kruskal.general#debe ser cercano a cero y menor que el primero



```

